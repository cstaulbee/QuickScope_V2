{
  "flow_id": "current_state_mapping_v1",
  "version": "1.0.0",
  "purpose": "Capture detailed current-state workflows, data elements, status model, controls, measures, and validate consistency",
  "global_rules": {
    "tone": {
      "style": "business-friendly",
      "jargon_policy": "avoid_technical_terms",
      "question_style": "one_question_at_a_time",
      "use_examples": true,
      "confirm_key_decisions": true
    },
    "conversation_policies": {
      "do_not_advance_on_ambiguity": true,
      "handle_idk_with_examples": true,
      "resolve_contradictions_before_finalize": true,
      "max_workflows_to_map": 3,
      "prefer_current_process_over_future_ideal": true,
      "no_solutioning_until_current_state_confirmed": true,
      "always_capture_real_example": true,
      "always_capture_exceptions": true
    },
    "scope_guardrails": {
      "focus_on": [
        "Current state: what actually happens today",
        "Roles and handoffs",
        "Inputs/outputs per step",
        "Decisions and business rules (as currently practiced)",
        "Exceptions, rework loops, and delays",
        "Artifacts used today (forms, spreadsheets, emails, photos, reports)",
        "Process measures (cycle time, lead time, error/rework, SLAs) as currently known"
      ],
      "explicitly_exclude": [
        "Future-state redesign brainstorming (until after current state is confirmed)",
        "Technical architecture decisions",
        "Tool/vendor selection",
        "Training and change management plans",
        "Organizational politics or unrelated internal issues"
      ]
    }
  },
  "context": {
    "slots": {
      "reality_checks": {
        "cycle_time": {
          "typical": null,
          "best_case": null,
          "worst_case": null
        },
        "lead_time": {
          "typical": null,
          "best_case": null,
          "worst_case": null
        },
        "wait_states": [],
        "error_and_rework": {
          "common_error_types": [],
          "rework_frequency": null,
          "scrap_or_waste_notes": null
        },
        "service_levels": {
          "slas_exist": null,
          "sla_definitions": []
        },
        "compliance_safety_constraints": [],
        "capacity_constraints": []
      },
      "artifacts": {
        "systems_tools": [],
        "documents_and_templates": [],
        "spreadsheets": [
          {
            "name": null,
            "purpose": null,
            "key_columns_or_sections": []
          }
        ],
        "communications": {
          "common_emails_or_messages": [],
          "handoff_channels": []
        },
        "files_media": {
          "file_types": [],
          "photos_video_used": null,
          "where_stored_today": null
        }
      },
      "roles": {
        "observed_roles": [],
        "role_definitions": [],
        "handoffs": []
      },
      "workflows": {
        "selected_workflows": [],
        "maps": [
          {
            "workflow_id": null,
            "workflow_name": null,
            "trigger": null,
            "start_condition": null,
            "end_condition": null,
            "lanes": [],
            "steps": [],
            "decisions": [],
            "exceptions": [],
            "wait_states": [],
            "artifacts_touched": [],
            "notes": []
          }
        ]
      },
      "workflow_capture_state": {
        "active_workflow_id": null,
        "active_step_index": 0,
        "workflow_level_buffer": {
          "trigger": null,
          "start_condition": null,
          "end_condition": null
        },
        "active_step_buffer": {
          "description": null,
          "owner_role": null,
          "inputs": [],
          "outputs": [],
          "systems_tools_used": [],
          "decision": null,
          "decision_outcomes": [],
          "wait_or_delay": null,
          "common_exception": null
        },
        "active_step_flags": {
          "has_decision": false
        }
      },
      "process_parameters": {
        "data_elements": [
          {
            "data_id": null,
            "name": null,
            "definition": null,
            "example_value": null,
            "kind": null,
            "required_when": null,
            "source_today": null,
            "owner_role": null,
            "validation_rules_today": [],
            "privacy_sensitivity": null
          }
        ],
        "status_model": {
          "statuses": [],
          "status_definitions": [],
          "transitions": [
            {
              "from_status": null,
              "to_status": null,
              "who_can_move": [],
              "conditions_required": [],
              "common_reasons": []
            }
          ],
          "done_definition": null
        },
        "controls": [
          {
            "control_id": null,
            "type": null,
            "where_in_process": null,
            "what_it_prevents_or_detects": null,
            "how_it_works_today": null,
            "evidence_or_audit_trail": null
          }
        ],
        "measures": [
          {
            "measure_id": null,
            "name": null,
            "why_it_matters": null,
            "how_measured_today": null,
            "target_or_expectation": null,
            "where_data_lives_today": null
          }
        ],
        "decision_rules": [
          {
            "rule_id": null,
            "decision_point": null,
            "rule_statement": null,
            "who_decides": [],
            "inputs_needed": [],
            "examples": []
          }
        ]
      },
      "pain_points": {
        "problems": [],
        "top_bottlenecks": [],
        "workarounds": [],
        "impact": {
          "cost": null,
          "time": null,
          "risk": null,
          "customer_impact": null,
          "employee_friction": null
        }
      },
      "validation": {
        "gaps": [],
        "contradictions": [],
        "must_handle_scenarios": []
      }
    }
  },
  "stages": [
    {
      "id": "reality_checks",
      "type": "questions",
      "questions": [
        {
          "id": "cycle_time_typical",
          "ask": "For one typical case, how long does the work time take (excluding waiting)?",
          "save_to": "reality_checks.cycle_time.typical",
          "clarify_if": [
            {
              "condition": "vague",
              "follow_up": "Is it minutes, hours, days, or weeks?"
            }
          ]
        },
        {
          "id": "lead_time_typical",
          "ask": "From start trigger to done, how long does it typically take including waiting?",
          "save_to": "reality_checks.lead_time.typical",
          "clarify_if": [
            {
              "condition": "vague",
              "follow_up": "Is it usually same-day, multi-day, or longer?"
            }
          ]
        },
        {
          "id": "wait_states",
          "ask": "Where does it usually wait or get stuck? List the top 2–5 waiting points.",
          "save_to": "reality_checks.wait_states",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "If you had to pick one spot where things sit the longest, where is it?"
            }
          ]
        },
        {
          "id": "errors_rework",
          "ask": "What are the most common errors or rework loops (what gets redone, corrected, or returned)?",
          "save_to": "reality_checks.error_and_rework.common_error_types"
        },
        {
          "id": "slas_exist",
          "ask": "Are there any deadlines or service expectations (formal or informal) people try to meet?",
          "save_to": "reality_checks.service_levels.slas_exist",
          "clarify_if": [
            {
              "condition": "unclear_yes_no",
              "follow_up": "Which is closer: no real deadlines, or there are expectations like 'within 24 hours' or 'by end of week'?"
            }
          ]
        },
        {
          "id": "sla_definitions",
          "ask": "If yes, what are the key expectations (examples are fine)?",
          "save_to": "reality_checks.service_levels.sla_definitions"
        },
        {
          "id": "compliance_safety",
          "ask": "Are there compliance, safety, or legal constraints that shape how this is done today?",
          "save_to": "reality_checks.compliance_safety_constraints"
        },
        {
          "id": "capacity_constraints",
          "ask": "What capacity constraints affect it (staffing, equipment availability, supplier delays, shift limits, etc.)?",
          "save_to": "reality_checks.capacity_constraints"
        }
      ],
      "next": "artifacts_inventory"
    },
    {
      "id": "artifacts_inventory",
      "type": "questions",
      "questions": [
        {
          "id": "systems_tools",
          "ask": "What systems or tools are used today (software, machines, devices, portals, scanners, etc.)?",
          "save_to": "artifacts.systems_tools"
        },
        {
          "id": "documents_templates",
          "ask": "What documents or templates are used (forms, checklists, PDFs, standard emails)?",
          "save_to": "artifacts.documents_and_templates"
        },
        {
          "id": "spreadsheets",
          "ask": "Do you use any spreadsheets or shared trackers? If yes, what are the key columns/sections?",
          "save_to": "artifacts.spreadsheets"
        },
        {
          "id": "handoff_channels",
          "ask": "How do handoffs happen today (email, phone, chat, paper, in-person, system assignment)?",
          "save_to": "artifacts.communications.handoff_channels"
        },
        {
          "id": "files_media",
          "ask": "Do you use files/photos/videos? If yes, what types and where are they stored today?",
          "save_to": "artifacts.files_media"
        }
      ],
      "next": "pain_points_capture"
    },
    {
      "id": "pain_points_capture",
      "type": "questions",
      "questions": [
        {
          "id": "problems",
          "ask": "What are the biggest problems with how this works today? (short bullets)",
          "save_to": "pain_points.problems",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "Where do people complain, redo work, or lose track of things?"
            }
          ]
        },
        {
          "id": "top_bottlenecks",
          "ask": "Where are the top 1–3 bottlenecks (the spots that limit speed or quality most)?",
          "save_to": "pain_points.top_bottlenecks"
        },
        {
          "id": "workarounds",
          "ask": "What workarounds do people use to make it work anyway?",
          "save_to": "pain_points.workarounds"
        },
        {
          "id": "impact",
          "ask": "What's the impact of the problems (time lost, cost, risk, customer impact, employee frustration)?",
          "save_to": "pain_points.impact"
        }
      ],
      "next": "workflow_selection"
    },
    {
      "id": "workflow_selection",
      "type": "message",
      "prompt": "Great! We'll now map this process step by step, capturing what actually happens today.",
      "next": "workflow_init"
    },
    {
      "id": "workflow_init",
      "type": "action",
      "action": "initialize_workflow_maps_from_selection",
      "save_to": "workflows.maps",
      "next": "workflow_trigger_capture"
    },
    {
      "id": "workflow_trigger_capture",
      "type": "questions",
      "questions": [
        {
          "id": "workflow_trigger",
          "ask": "What is the trigger event that starts this process?",
          "save_to": "workflow_capture_state.workflow_level_buffer.trigger",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "What specific event kicks it off—a customer request, a scheduled time, a system alert, an order arrival, etc.?"
            }
          ]
        },
        {
          "id": "workflow_start_condition",
          "ask": "What must be true before this process can start (preconditions, ready states)?",
          "save_to": "workflow_capture_state.workflow_level_buffer.start_condition",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "For example: required approvals, materials available, customer info validated, etc."
            }
          ]
        }
      ],
      "next": "workflow_trigger_commit"
    },
    {
      "id": "workflow_trigger_commit",
      "type": "action",
      "action": "write_trigger_to_active_workflow",
      "save_to": "workflows.maps",
      "next": "workflow_first_step_intro"
    },
    {
      "id": "workflow_first_step_intro",
      "type": "message",
      "prompt": "Great! Now let's walk through this process step-by-step. I'll ask about one step at a time.",
      "next": "workflow_step_capture__step_description"
    },
    {
      "id": "workflow_step_capture__step_description",
      "type": "questions",
      "questions": [
        {
          "id": "step_description",
          "ask": "What's the first action that happens after the trigger? (current state, not ideal future)",
          "save_to": "workflow_capture_state.active_step_buffer.description",
          "clarify_if": [
            {
              "condition": "vague",
              "follow_up": "What does someone actually do—call, check, enter, move, inspect, assign, approve, print, deliver?"
            }
          ]
        }
      ],
      "next": "workflow_step_capture__owner"
    },
    {
      "id": "workflow_step_capture__owner",
      "type": "questions",
      "questions": [
        {
          "id": "step_owner",
          "ask": "Who performs this specific step (single role or person)?",
          "save_to": "workflow_capture_state.active_step_buffer.owner_role",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "If multiple roles can do it, who usually does it today?"
            }
          ]
        }
      ],
      "next": "workflow_step_capture__inputs"
    },
    {
      "id": "workflow_step_capture__inputs",
      "type": "questions",
      "questions": [
        {
          "id": "step_inputs",
          "ask": "What do they need to perform this step (information, materials, approvals, tools, files)?",
          "save_to": "workflow_capture_state.active_step_buffer.inputs"
        }
      ],
      "next": "workflow_step_capture__outputs"
    },
    {
      "id": "workflow_step_capture__outputs",
      "type": "questions",
      "questions": [
        {
          "id": "step_outputs",
          "ask": "What gets produced or changed by this step (updated info, a document, a part moved, a decision made, etc.)?",
          "save_to": "workflow_capture_state.active_step_buffer.outputs"
        }
      ],
      "next": "workflow_step_capture__systems"
    },
    {
      "id": "workflow_step_capture__systems",
      "type": "questions",
      "questions": [
        {
          "id": "step_systems",
          "ask": "What tools/systems are used during this step (if any)?",
          "save_to": "workflow_capture_state.active_step_buffer.systems_tools_used"
        }
      ],
      "next": "workflow_step_capture__decision_wait_exception"
    },
    {
      "id": "workflow_step_capture__decision_wait_exception",
      "type": "questions",
      "questions": [
        {
          "id": "step_decision",
          "ask": "Is there a decision here that changes what happens next? Answer 'No' if there isn't one, or state the decision question in plain terms (e.g., 'Is the order approved?', 'Does the item pass inspection?')",
          "save_to": "workflow_capture_state.active_step_buffer.decision",
          "clarify_if": [
            {
              "condition": "vague",
              "follow_up": "Please answer either 'No' if there's no decision, or phrase it as a clear yes/no question (e.g., 'Does the client approve the plan?')"
            }
          ]
        }
      ],
      "next": "workflow_step_check_decision"
    },
    {
      "id": "workflow_step_check_decision",
      "type": "action",
      "action": "check_step_has_decision",
      "save_to": "workflow_capture_state.active_step_flags",
      "next": "workflow_step_decision_branch"
    },
    {
      "id": "workflow_step_decision_branch",
      "type": "branch",
      "branches": [
        {
          "when": { "action_result_equals": { "value": "has_decision" } },
          "next": "workflow_step_capture__decision_outcomes"
        },
        {
          "when": { "action_result_equals": { "value": "no_decision" } },
          "next": "workflow_step_capture__wait_exception"
        }
      ]
    },
    {
      "id": "workflow_step_capture__decision_outcomes",
      "type": "questions",
      "questions": [
        {
          "id": "decision_outcomes",
          "ask": "List 2-3 outcomes with what happens next for each. Use this format (one per line):\nApproved -> Next: [next step name]\nRejected -> End: [reason]\nNeeds info -> Next: [next step name]",
          "save_to": "workflow_capture_state.active_step_buffer.decision_outcomes",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "Please use the format: 'OutcomeName -> Next: StepName' or 'OutcomeName -> End: Reason'. For example:\nApproved -> Next: Ship order\nRejected -> End: Cancel and refund"
            }
          ]
        }
      ],
      "next": "workflow_step_normalize_decision_data"
    },
    {
      "id": "workflow_step_normalize_decision_data",
      "type": "action",
      "action": "normalize_and_parse_decision_data",
      "next": "workflow_step_capture__wait_exception"
    },
    {
      "id": "workflow_step_capture__wait_exception",
      "type": "questions",
      "questions": [
        {
          "id": "step_wait",
          "ask": "Does it wait after this step? If yes, what does it wait for and how long is typical?",
          "save_to": "workflow_capture_state.active_step_buffer.wait_or_delay"
        },
        {
          "id": "step_exception",
          "ask": "What's the most common thing that goes wrong at this step, and what happens when it does?",
          "save_to": "workflow_capture_state.active_step_buffer.common_exception"
        }
      ],
      "next": "workflow_step_confirm_detail"
    },
    {
      "id": "workflow_step_confirm_detail",
      "type": "confirm",
      "summary_template": "Step captured:\n- What happens: {{workflow_capture_state.active_step_buffer.description}}\n- Owner: {{workflow_capture_state.active_step_buffer.owner_role}}\n- Inputs: {{workflow_capture_state.active_step_buffer.inputs}}\n- Outputs: {{workflow_capture_state.active_step_buffer.outputs}}\n- Systems: {{workflow_capture_state.active_step_buffer.systems_tools_used}}",
      "ask": "Is this step captured correctly?",
      "on_yes": "workflow_step_commit",
      "on_no": "workflow_step_capture__step_description"
    },
    {
      "id": "workflow_step_commit",
      "type": "action",
      "action": "commit_step_to_active_workflow",
      "save_to": "workflows.maps",
      "next": "workflow_update_diagram"
    },
    {
      "id": "workflow_update_diagram",
      "type": "action",
      "action": "update_live_bpmn_artifact",
      "save_to": "workflow_capture_state.live_diagram_path",
      "next": "workflow_diagram_notification"
    },
    {
      "id": "workflow_diagram_notification",
      "type": "message",
      "prompt": "Step captured! Live diagram updated.",
      "next": "workflow_ask_next_step"
    },
    {
      "id": "workflow_ask_next_step",
      "type": "questions",
      "questions": [
        {
          "id": "next_step_check",
          "ask": "What happens next in the process? (Or type 'done' if that was the last step)",
          "save_to": "workflow_capture_state.next_step_response"
        }
      ],
      "next": "workflow_check_if_done"
    },
    {
      "id": "workflow_check_if_done",
      "type": "action",
      "action": "check_if_user_said_done",
      "save_to": "workflow_capture_state.workflow_status",
      "next": "workflow_step_routing"
    },
    {
      "id": "workflow_step_routing",
      "type": "branch",
      "branches": [
        {
          "when": { "action_result_equals": { "value": "continue" } },
          "next": "workflow_copy_description_to_buffer"
        },
        {
          "when": { "action_result_equals": { "value": "done" } },
          "next": "workflow_end_condition_capture"
        }
      ]
    },
    {
      "id": "workflow_copy_description_to_buffer",
      "type": "action",
      "action": "copy_next_step_to_buffer",
      "save_to": "workflow_capture_state.active_step_buffer",
      "next": "workflow_step_capture__owner"
    },
    {
      "id": "workflow_end_condition_capture",
      "type": "questions",
      "questions": [
        {
          "id": "end_condition",
          "ask": "All steps captured! What proves this process is 'Done'? (What deliverable, state, or confirmation marks completion?)",
          "save_to": "workflow_capture_state.workflow_level_buffer.end_condition"
        }
      ],
      "next": "workflow_end_condition_commit"
    },
    {
      "id": "workflow_end_condition_commit",
      "type": "action",
      "action": "write_trigger_to_active_workflow",
      "save_to": "workflows.maps",
      "next": "workflow_confirm"
    },
    {
      "id": "workflow_confirm",
      "type": "confirm",
      "summary_template": "I captured this workflow:\n- Trigger: {{workflows.maps[0].trigger}}\n- Steps count: {{workflows.maps[0].steps}}\n- End condition: {{workflows.maps[0].end_condition}}\n- Top exceptions: {{workflows.maps[0].exceptions}}\nIs the sequence accurate for how it works today?",
      "ask": "Is that accurate?",
      "on_yes": "decision_rules_capture",
      "on_no": "workflow_fixup"
    },
    {
      "id": "workflow_fixup",
      "type": "questions",
      "questions": [
        {
          "id": "workflow_fix",
          "ask": "What should be corrected (missing steps, wrong order, wrong role, missing exception)?",
          "save_to": "validation.gaps"
        }
      ],
      "next": "workflow_fixup_action"
    },
    {
      "id": "workflow_fixup_action",
      "type": "action",
      "action": "apply_workflow_corrections",
      "save_to": "workflows.maps",
      "next": "workflow_confirm"
    },
    {
      "id": "decision_rules_capture",
      "type": "questions",
      "questions": [
        {
          "id": "decision_points",
          "ask": "List the biggest decisions that change the path (approvals, priority, acceptance/rejection, pass/fail).",
          "save_to": "process_parameters.decision_rules",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "Think: when does someone stop and decide which route to take?"
            }
          ]
        }
      ],
      "next": "decision_rules_action"
    },
    {
      "id": "decision_rules_action",
      "type": "action",
      "action": "normalize_and_expand_decision_rules",
      "save_to": "process_parameters.decision_rules",
      "next": "data_elements_derive"
    },
    {
      "id": "data_elements_derive",
      "type": "action",
      "action": "derive_candidate_data_elements_from_workflows_and_artifacts",
      "save_to": "process_parameters.data_elements",
      "next": "data_elements_validate_loop_gate"
    },
    {
      "id": "data_elements_validate_loop_gate",
      "type": "gate",
      "criteria": [
        { "slot": "process_parameters.data_elements", "min_items": 5, "required": true }
      ],
      "on_fail": "data_elements_manual_prompt",
      "on_pass": "data_elements_validate_loop"
    },
    {
      "id": "data_elements_manual_prompt",
      "type": "questions",
      "questions": [
        {
          "id": "manual_fields",
          "ask": "Name the most important pieces of information people must capture or look up to complete the process (10–20 items).",
          "save_to": "process_parameters.data_elements"
        }
      ],
      "next": "data_elements_validate_loop"
    },
    {
      "id": "data_elements_validate_loop",
      "type": "loop",
      "loop_purpose": "Validate each data element so it's unambiguous and build-informative, without technical jargon.",
      "prompt": "We'll confirm the key pieces of information one by one so the model is unambiguous.",
      "stop_condition": {
        "description": "All candidate data elements are validated or intentionally discarded.",
        "signal_slot": "process_parameters.data_elements"
      },
      "on_stop": "status_model_capture",
      "next": "data_element_one_by_one"
    },
    {
      "id": "data_element_one_by_one",
      "type": "action",
      "action": "select_next_data_element_for_validation",
      "save_to": "process_parameters.data_elements",
      "next": "data_element_questions"
    },
    {
      "id": "data_element_questions",
      "type": "questions",
      "questions": [
        {
          "id": "de_definition",
          "ask": "For '{{process_parameters.data_elements[current].name}}', what does it mean in plain terms?",
          "save_to": "process_parameters.data_elements[current].definition"
        },
        {
          "id": "de_example",
          "ask": "Give an example value for it.",
          "save_to": "process_parameters.data_elements[current].example_value"
        },
        {
          "id": "de_kind",
          "ask": "Is it best described as: free text, number, date/time, yes/no, pick from a list, or an attached file?",
          "save_to": "process_parameters.data_elements[current].kind"
        },
        {
          "id": "de_required_when",
          "ask": "When is it required (always, only for certain cases, only at a certain step)?",
          "save_to": "process_parameters.data_elements[current].required_when"
        },
        {
          "id": "de_source_today",
          "ask": "Where does it come from today (entered by a person, pulled from a system, on a document, from a vendor, etc.)?",
          "save_to": "process_parameters.data_elements[current].source_today"
        },
        {
          "id": "de_owner_role",
          "ask": "Who is responsible for it being correct (what role)?",
          "save_to": "process_parameters.data_elements[current].owner_role"
        },
        {
          "id": "de_validation",
          "ask": "Are there any rules people use today to validate it (format, range, must match something, required attachment)?",
          "save_to": "process_parameters.data_elements[current].validation_rules_today"
        },
        {
          "id": "de_sensitivity",
          "ask": "Is it sensitive (personal, financial, medical, legal, safety-critical)? If yes, what type?",
          "save_to": "process_parameters.data_elements[current].privacy_sensitivity"
        }
      ],
      "next": "data_element_commit"
    },
    {
      "id": "data_element_commit",
      "type": "action",
      "action": "commit_validated_data_element",
      "save_to": "process_parameters.data_elements",
      "next": "data_elements_validate_loop"
    },
    {
      "id": "status_model_capture",
      "type": "questions",
      "questions": [
        {
          "id": "statuses",
          "ask": "What stages/statuses do people use today to describe progress (3–9 stages)?",
          "save_to": "process_parameters.status_model.statuses"
        },
        {
          "id": "done_definition",
          "ask": "In one sentence: what does 'Done' mean in a way everyone agrees on?",
          "save_to": "process_parameters.status_model.done_definition"
        }
      ],
      "next": "status_transitions_capture"
    },
    {
      "id": "status_transitions_capture",
      "type": "questions",
      "questions": [
        {
          "id": "transitions",
          "ask": "What are the normal moves between statuses (for example: New → Scheduled → In Progress → Done)?",
          "save_to": "process_parameters.status_model.transitions",
          "clarify_if": [
            {
              "condition": "empty_or_too_short",
              "follow_up": "List 3–7 common status changes people make."
            }
          ]
        },
        {
          "id": "who_moves",
          "ask": "Who is allowed to move work forward today (what roles), and what must be true before they do?",
          "save_to": "process_parameters.status_model.transitions"
        }
      ],
      "next": "controls_measures_capture"
    },
    {
      "id": "controls_measures_capture",
      "type": "questions",
      "questions": [
        {
          "id": "controls",
          "ask": "What prevents mistakes today (checklists, reviews, inspections, approvals, sign-offs, required fields, etc.)?",
          "save_to": "process_parameters.controls"
        },
        {
          "id": "measures",
          "ask": "What does the business care about measuring for this process (speed, quality, cost, safety, customer satisfaction)?",
          "save_to": "process_parameters.measures"
        },
        {
          "id": "how_measured_today",
          "ask": "How are those measures tracked today (where does the data live)?",
          "save_to": "process_parameters.measures"
        }
      ],
      "next": "scenarios_capture"
    },
    {
      "id": "scenarios_capture",
      "type": "questions",
      "questions": [
        {
          "id": "must_handle_scenarios",
          "ask": "Give me 8–15 real scenarios the current process must handle (include at least 3 problem scenarios). Short bullets are fine.",
          "save_to": "validation.must_handle_scenarios",
          "clarify_if": [
            {
              "condition": "too_few_items",
              "follow_up": "Add a few more, including: a rush case, a missing info case, and a case that gets rejected and reworked."
            }
          ]
        }
      ],
      "next": "consistency_checks"
    },
    {
      "id": "consistency_checks",
      "type": "action",
      "action": "detect_gaps_and_contradictions",
      "save_to": "validation",
      "next": "consistency_gate"
    },
    {
      "id": "consistency_gate",
      "type": "gate",
      "criteria": [
        { "slot": "validation.contradictions", "max_items": 0, "required": true }
      ],
      "on_fail": "resolve_contradictions",
      "on_pass": "current_state_confirm"
    },
    {
      "id": "resolve_contradictions",
      "type": "questions",
      "questions": [
        {
          "id": "resolve_contradictions",
          "ask": "I found a few inconsistencies. Let's resolve them one at a time: {{validation.contradictions}}. Which should be true for current state?",
          "save_to": "validation.contradictions"
        }
      ],
      "next": "consistency_checks"
    },
    {
      "id": "current_state_confirm",
      "type": "confirm",
      "summary_template": "We now have a current-state model with:\n- SIPOC confirmed\n- {{workflows.maps}} workflow map(s)\n- Data elements catalog\n- Status model\n- Controls and measures\n- Scenarios\n\nDo you confirm this describes how it works today (even if you don't like it)?",
      "ask": "Is that current-state model accurate?",
      "on_yes": "end",
      "on_no": "workflow_selection"
    },
    {
      "id": "end",
      "type": "message",
      "prompt": "Excellent! Current-state workflow mapping complete. Ready to generate outputs."
    }
  ],
  "actions": {
    "initialize_workflow_maps_from_selection": {
      "description": "Create workflow map skeletons from workflows.selected_workflows, assign workflow_id, set active_workflow_id to the first, and initialize capture state."
    },
    "write_trigger_to_active_workflow": {
      "description": "Write workflow_level_buffer fields (trigger, start_condition, end_condition) to the active workflow and clear the buffer."
    },
    "check_step_has_decision": {
      "description": "Check if active_step_buffer has a non-empty decision field and set active_step_flags.has_decision flag."
    },
    "update_live_bpmn_artifact": {
      "description": "Generate Mermaid BPMN-lite diagram from active workflow and write to artifacts/live_bpmn_<workflow_id>.mmd."
    },
    "commit_step_to_active_workflow": {
      "description": "Append workflow_capture_state.active_step_buffer as a new step in the active workflow, infer lane list, extract artifacts touched, and reset active_step_buffer."
    },
    "advance_or_close_workflow_based_on_response": {
      "description": "If user indicates 'done', set active workflow end_condition and mark workflow closed; otherwise store next step seed and continue."
    },
    "apply_workflow_corrections": {
      "description": "Apply corrections (insert step, reorder, change owner, add exception) to the active workflow."
    },
    "normalize_and_expand_decision_rules": {
      "description": "Normalize decisions into rule candidates with rule_statement, who_decides, inputs_needed, and examples placeholders."
    },
    "derive_candidate_data_elements_from_workflows_and_artifacts": {
      "description": "Extract candidate data elements from step inputs/outputs, artifacts, identifiers, and decision rules; de-duplicate by name."
    },
    "select_next_data_element_for_validation": {
      "description": "Select the next unvalidated data element for user confirmation; set an internal pointer 'current'."
    },
    "commit_validated_data_element": {
      "description": "Mark the current data element as validated and persist edits."
    },
    "detect_gaps_and_contradictions": {
      "description": "Detect missing essentials (e.g., no end_condition, missing owners, missing artifacts) and contradictions (e.g., SLA exists but no definition). Populate validation.gaps and validation.contradictions."
    }
  }
}
